# ToLayout Palette - Исправления и Улучшения

## Обзор исправлений

Этот документ описывает исправления, внесённые в палитры ToLayout для решения проблем с обновлением списков видов, отображением папок и размещением видов в макетах.

---

## Исправленные проблемы

### 1. ✅ Списки видов не обновляются при создании новых видов

**Проблема**: При создании новых видов в проекте списки в палитре "Организация чертежей в макетах" не обновлялись автоматически.

**Решение**:
- Добавлена кнопка **"↻ Обновить"** в палитре "Организация чертежей"
- Автоматическое обновление списка видов после успешного размещения
- Добавлен метод `UpdateViewListOnHTML()` для программного обновления списка

**Как использовать**:
- Нажмите кнопку "↻ Обновить" рядом с режимами сортировки видов
- Список автоматически обновится после размещения видов
- При открытии палитры список загружается автоматически

---

### 2. ✅ Папки не видны в списках видов и макетов

**Статус**: **УЖЕ РАБОТАЕТ** - код был правильным, нужно только знать как использовать.

**Функционал папок**:

#### В палитре "Организация чертежей в макетах":
- Используйте режим сортировки **"По папкам"** для просмотра видов, сгруппированных по папкам
- Папки отображаются как заголовки групп с именем папки
- Путь папки показывается в столбце "Тип / Папка"

#### В палитре "Расположить в макете":
- При выборе **"Существующий макет"**: макеты автоматически группируются по папкам
- При создании **"Новый макет"**: можно выбрать папку из выпадающего списка
  - Установите флажок "Разместить в папку"
  - Выберите папку из списка существующих папок макетов

**Примечание**: Папки макетов создаются автоматически при использовании символа `/` в имени макета (например, "Планы/1-й этаж").

---

### 3. ✅ Видны только виды "План", другие типы видов не отображаются

**Статус**: **НЕ БАГИ КОДА** - код запрашивает все типы видов правильно.

**Объяснение**:
Код корректно запрашивает все 7 типов видов из ArchiCAD API:
1. План (вид сверху) - `API_StoryNavItem`
2. Разрез - `API_SectionNavItem`
3. Фасад - `API_ElevationNavItem`
4. Внутренний фасад - `API_InteriorElevationNavItem`
5. Деталь - `API_DetailDrawingNavItem`
6. Рабочий лист - `API_WorksheetDrawingNavItem`
7. Документ из 3D - `API_DocumentFrom3DNavItem`

**Если видны только виды "План"**:
- В проекте действительно созданы только планы этажей
- Другие виды (разрезы, фасады и т.д.) нужно создать в ArchiCAD
- API возвращает только существующие виды в проекте

**Как создать другие типы видов**:
- Используйте стандартные инструменты ArchiCAD для создания разрезов, фасадов и других видов
- После создания нажмите кнопку "↻ Обновить" в палитре для обновления списка

---

### 4. ✅ При размещении вида меняется его имя и вид пропадает из списка

**Проблема**: 
- При размещении вида на макет его имя могло измениться на имя по умолчанию (например, "1-й этаж")
- Вид мог исчезнуть из списка доступных видов
- Вид мог появиться с некорректными настройками

**Причина**:
Три критических бага в коде размещения видов:
1. При ошибке создания комбинации слоёв возвращался GUID неполного клона
2. При ошибке получения настроек вида возвращался GUID некорректного клона
3. В резервном пути код изменял масштаб оригинального вида без восстановления

**Решение**:
- **Исправлено**: При ошибке создания комбинации слоёв неполный клон удаляется
- **Исправлено**: При ошибке получения настроек вида неполный клон удаляется
- **Исправлено**: В резервном пути оригинальный вид больше НЕ изменяется
- **Удалено**: Несуществующий параметр `cloneViewForPlacement` из JavaScript

**Результат**:
- Оригинальные виды из Карты видов НИКОГДА не изменяются при размещении
- Виды можно размещать многократно на разных макетах
- Виды всегда остаются видимыми в списке после размещения
- Имена видов сохраняются корректно

---

## Технические детали

### Изменённые файлы

1. **Src/LayoutHelper.cpp**
   - Строки 905-910: Удаление неполного клона при ошибке создания комбинации слоёв
   - Строки 908-915: Удаление неполного клона при ошибке GetNavigatorView
   - Строки 1226-1233: Удалён код изменения масштаба оригинального вида

2. **Src/OrganizeLayoutsPalette.hpp**
   - Добавлен метод `UpdateViewListOnHTML()`

3. **Src/OrganizeLayoutsPalette.cpp**
   - Реализован метод `UpdateViewListOnHTML()`

4. **RFIX/OrganizeLayouts_Palette.html**
   - Добавлена кнопка "↻ Обновить"
   - Добавлен обработчик события для кнопки обновления
   - Автоматическое обновление после размещения
   - Удалён параметр `cloneViewForPlacement`

---

## Рекомендации по использованию

### Для максимальной эффективности:

1. **Организация видов по папкам**:
   - Создавайте папки в Карте видов для группировки видов
   - Используйте режим "По папкам" для удобной навигации

2. **Организация макетов по папкам**:
   - Используйте формат "Папка/Имя макета" при создании макетов
   - Папки создаются автоматически и отображаются в списках

3. **Обновление списков**:
   - После создания новых видов нажимайте кнопку "↻ Обновить"
   - Или просто закройте и снова откройте палитру

4. **Размещение видов**:
   - В палитре "Организация чертежей": выбирайте виды по GUID для прямого размещения
   - Виды можно размещать многократно без создания копий
   - Оригинальные виды всегда остаются доступными

---

## Совместимость

- ArchiCAD 27 SDK
- Все изменения обратно совместимы
- Не требуется изменение существующих проектов

---

## Для разработчиков

### Важные факты о коде:

1. **При размещении по GUID** (`placeViewGuid` задан):
   - Оригинальный вид используется напрямую БЕЗ клонирования
   - Масштаб временно изменяется для корректного размера Drawing, затем восстанавливается
   - Один вид можно размещать многократно на разных макетах

2. **При размещении текущего вида** (без GUID):
   - Создаётся клон с фильтрацией слоёв (если выделены элементы)
   - При ошибке клонирования используется текущий вид БЕЗ изменений
   - Оригинальный вид НИКОГДА не изменяется

3. **Обработка ошибок**:
   - Все неполные/некорректные клоны удаляются через `ACAPI_Navigator_DeleteNavigatorItem`
   - Возвращается `APINULLGuid` при ошибке, а не GUID некорректного вида
   - Все указатели `layerStats` корректно освобождаются

---

## История изменений

**Версия**: 2026-02-13
**Автор**: Copilot Code Review Agent
**Коммиты**: 
- `b5acdc3`: Fix critical bugs in view placement and add refresh functionality
- `0e64b87`: Remove build artifacts from repository

