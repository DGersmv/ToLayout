<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è —á–µ—Ä—Ç–µ–∂–µ–π –≤ –º–∞–∫–µ—Ç–∞—Ö</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #efefef; margin: 0; padding: 10px; color: #2f2f2f; font-size: 12px; }
    .palette { max-width: 420px; }
    h1 { font-size: 13px; font-weight: 600; margin: 0 0 8px; }
    .section { margin-bottom: 10px; }
    .section-title { font-weight: 600; margin-bottom: 4px; font-size: 11px; color: #54524f; }
    .grid-row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-bottom: 4px; }
    .grid-row label { display: flex; align-items: center; gap: 4px; }
    .grid-row input[type="number"] { width: 44px; padding: 4px; }
    select, input[type="text"] { padding: 4px 6px; border: 1px solid #a8a5a2; background: #fff; }
    .view-list { max-height: 140px; overflow-y: auto; border: 1px solid #c8c4c0; background: #fff; }
    .view-list table { width: 100%; border-collapse: collapse; font-size: 11px; }
    .view-list th { text-align: left; background: #dcd9d4; padding: 4px 6px; }
    .view-list td { padding: 4px 6px; border-bottom: 1px solid #eee; cursor: pointer; }
    .view-list tr.view-row:hover td { background: #f3f1ee; }
    .view-list tr.folder-row:hover td { background: #e8e6e3; }
    .view-list tr.selected td { background: #d4e8d4; }
    .queue-list { max-height: 100px; overflow-y: auto; border: 1px solid #c8c4c0; background: #fff; font-size: 11px; padding: 4px; }
    .queue-item { padding: 2px 0; border-bottom: 1px solid #eee; }
    .btn { padding: 6px 10px; cursor: pointer; border: 1px solid #4f604f; background: #7a997a; color: #fff; border-radius: 2px; font-size: 12px; }
    .btn:hover { background: #6a8a6a; }
    .btn:disabled { background: #aaa; border-color: #888; cursor: default; }
    .btn-secondary { background: #6a7a8a; border-color: #5a6a7a; }
    .btn-secondary:hover { background: #5a6a7a; }
    .info-msg { margin-top: 6px; font-size: 11px; min-height: 18px; }
    .layout-table { max-height: 120px; overflow-y: auto; border: 1px solid #c8c4c0; background: #fff; }
    .layout-table table { width: 100%; border-collapse: collapse; font-size: 11px; }
    .layout-table td { padding: 4px 6px; cursor: pointer; }
    .layout-table tr:hover td { background: #f3f1ee; }
    .layout-table tr.selected td { background: #d4e8d4; }
    .grid-preview-wrap { display: flex; align-items: center; gap: 8px; margin-top: 6px; }
    .grid-label-rows { font-size: 11px; color: #54524f; writing-mode: vertical-rl; transform: rotate(180deg); min-height: 100px; display: flex; align-items: center; justify-content: center; }
    .grid-preview-box { display: flex; flex-direction: column; align-items: stretch; }
    .grid-label-cols { font-size: 11px; color: #54524f; text-align: center; margin-bottom: 2px; }
    .grid-inner { display: grid; border: 2px solid #333; background: #ddd; gap: 1px; padding: 1px; }
    .grid-inner { width: 140px; height: 100px; }
    .grid-cell { background: #fff; cursor: pointer; min-height: 20px; min-width: 20px; }
    .grid-cell:hover { background: #e8f0e8; }
    .grid-cell.selected { background: #7a997a; }
  </style>
</head>
<body>
<div class="palette">
  <h1>–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è —á–µ—Ä—Ç–µ–∂–µ–π –≤ –º–∞–∫–µ—Ç–∞—Ö</h1>
  <button type="button" class="btn btn-secondary" id="btn-refresh" style="margin-bottom:10px;">–û–±–Ω–æ–≤–∏—Ç—å</button>

  <div class="section">
    <div class="section-title">–ú–∞–∫–µ—Ç</div>
    <div class="grid-row">
      <label><input type="radio" name="layout-mode" value="existing" checked /> –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π</label>
      <label><input type="radio" name="layout-mode" value="new" /> –ù–æ–≤—ã–π –∏–∑ —à–∞–±–ª–æ–Ω–∞</label>
    </div>
    <div id="layout-existing-block">
      <input type="text" id="layout-search" placeholder="–ü–æ–∏—Å–∫ –º–∞–∫–µ—Ç–∞‚Ä¶" style="width:100%;margin-bottom:4px;" />
      <div id="layout-table-container" class="layout-table">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
    </div>
    <div id="layout-new-block" style="display:none;">
      <select id="master-select" style="width:100%;margin-bottom:4px;"><option value="-1">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</option></select>
      <input type="text" id="layout-name" placeholder="–ò–º—è –º–∞–∫–µ—Ç–∞" style="width:100%;" />
    </div>
  </div>

  <div class="section">
    <div class="section-title">–°–µ—Ç–∫–∞ –º–∞–∫–µ—Ç–∞</div>
    <div class="grid-row">
      <label>–°—Ç–æ–ª–±—Ü–æ–≤: <input type="number" id="grid-cols" min="1" max="4" value="2" /></label>
      <label>–°—Ç—Ä–æ–∫: <input type="number" id="grid-rows" min="1" max="4" value="3" /></label>
      <label>–ó–∞–∑–æ—Ä –º–º: <input type="number" id="grid-gap" min="0" value="0" style="width:40px;" /></label>
    </div>
    <div class="grid-preview-wrap">
      <div class="grid-label-rows" id="grid-label-rows">–°—Ç—Ä–æ–∫: 3</div>
      <div class="grid-preview-box">
        <div class="grid-label-cols" id="grid-label-cols">–°—Ç–æ–ª–±—Ü–æ–≤: 2</div>
        <div id="grid-inner" class="grid-inner landscape"></div>
      </div>
    </div>
    <p style="font-size:10px;color:#666;margin:4px 0 0 0;">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Å–µ–∫—Ç–æ—Ä, –∑–∞—Ç–µ–º –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥ –∏ ¬´–î–æ–±–∞–≤–∏—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å¬ª.</p>
    <p class="info-msg" id="assigned-sector-msg" style="margin:4px 0 0 0;font-weight:600;">–ù–∞–∑–Ω–∞—á–µ–Ω–æ: –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ</p>
  </div>

  <div class="section">
    <div class="section-title">–í–∏–¥</div>
    <div class="grid-row" style="margin-bottom:6px;">
      <label style="font-size:11px;"><input type="radio" name="view-sort" value="all" checked /> –í—Å–µ –≤–∏–¥—ã</label>
      <label style="font-size:11px;"><input type="radio" name="view-sort" value="byType" /> –ü–æ —Ç–∏–ø—É</label>
      <label style="font-size:11px;"><input type="radio" name="view-sort" value="byFolder" /> –ü–æ –ø–∞–ø–∫–∞–º</label>
    </div>
    <input type="text" id="view-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –≤–∏–¥–∞‚Ä¶" style="width:100%;margin-bottom:4px;" />
    <div id="view-list-container" class="view-list">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
    <button type="button" class="btn" id="btn-add" style="margin-top:6px;">–î–æ–±–∞–≤–∏—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å</button>
  </div>

  <div class="section">
    <div class="section-title">–û—á–µ—Ä–µ–¥—å —Ä–∞–∑–º–µ—â–µ–Ω–∏—è</div>
    <div id="queue-container" class="queue-list">–ü—É—Å—Ç–æ. –í—ã–±–µ—Ä–∏—Ç–µ –æ–±–ª–∞—Å—Ç—å, –≤–∏–¥ –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–î–æ–±–∞–≤–∏—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å¬ª.</div>
    <button type="button" class="btn" id="btn-ok" style="margin-top:8px;width:100%;">OK ‚Äî —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å –≤—Å–µ</button>
  </div>

  <div class="info-msg" id="info-msg"></div>
</div>

<script type="text/javascript">
"use strict";

var layoutGroupsData = null;
var placeableViews = [];
var queue = [];
var selectedViewGuid = null;
var selectedSectorRow = null;
var selectedSectorCol = null;
var lastAspect = 'landscape';
var expandedFolders = new Set();  // –î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ä–∞—Å–∫—Ä—ã—Ç—ã—Ö –ø–∞–ø–æ–∫

function setInfo(msg) {
  var el = document.getElementById('info-msg');
  if (el) el.textContent = msg || '';
}

function escapeHtml(text) {
  var div = document.createElement('div');
  div.textContent = text || '';
  return div.innerHTML;
}

function getLayoutIndex() {
  var radios = document.querySelectorAll('input[name="existing-layout"]');
  for (var i = 0; i < radios.length; i++) {
    if (radios[i].checked)
      return parseInt(radios[i].value, 10);
  }
  return -1;
}

function renderLayoutTable(filterStr) {
  var container = document.getElementById('layout-table-container');
  if (!container || !layoutGroupsData || layoutGroupsData.length === 0) {
    if (container && layoutGroupsData && layoutGroupsData.length === 0)
      container.innerHTML = '<div style="padding:8px;">–ù–µ—Ç –º–∞–∫–µ—Ç–æ–≤</div>';
    return;
  }
  var q = (filterStr || '').trim().toLowerCase();
  var html = '<table><tbody>';
  for (var gi = 0; gi < layoutGroupsData.length; gi++) {
    var g = layoutGroupsData[gi];
    var items = g.layouts || [];
    for (var k = 0; k < items.length; k++) {
      var it = items[k];
      var globalIndex = typeof it.index === 'number' ? it.index : k;
      var name = (it.name || ('–ú–∞–∫–µ—Ç ' + (globalIndex + 1))).toString();
      if (q && name.toLowerCase().indexOf(q) === -1) continue;
      html += '<tr data-index="' + globalIndex + '"><td>' + escapeHtml(name) + '</td></tr>';
    }
  }
  html += '</tbody></table>';
  container.innerHTML = html || '<div style="padding:8px;">–ù–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π</div>';
  container.querySelectorAll('tr').forEach(function(tr) {
    tr.addEventListener('click', function() {
      container.querySelectorAll('tr').forEach(function(r) { r.classList.remove('selected'); });
      tr.classList.add('selected');
      // –ü—Ä–∏ —Å–º–µ–Ω–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –º–∞–∫–µ—Ç–∞ –æ–±–Ω–æ–≤–ª—è–µ–º —Ñ–æ—Ä–º–∞—Ç –ø—Ä–µ–≤—å—é —Å–µ—Ç–∫–∏
      updateGridAspectFromLayoutSelection();
    });
  });
}

function updateLayoutTable() {
  var A = window.ACAPI;
  var container = document.getElementById('layout-table-container');
  if (!A || typeof A.GetLayoutsTree !== 'function') {
    if (container) container.innerHTML = 'API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
    return;
  }
  A.GetLayoutsTree().then(function(groups) {
    layoutGroupsData = groups;
    if (!groups || groups.length === 0) {
      container.innerHTML = '<div style="padding:8px;">–ù–µ—Ç –º–∞–∫–µ—Ç–æ–≤</div>';
      return;
    }
    renderLayoutTable(document.getElementById('layout-search').value);
  }).catch(function() {
    layoutGroupsData = null;
    container.innerHTML = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
  });
}

function getGridValues() {
  var rows = Math.max(1, Math.min(4, parseInt(document.getElementById('grid-rows').value, 10) || 1));
  var cols = Math.max(1, Math.min(4, parseInt(document.getElementById('grid-cols').value, 10) || 1));
  return { rows: rows, cols: cols };
}

function updateAssignedSectorMessage() {
  var el = document.getElementById('assigned-sector-msg');
  if (!el) return;
  if (selectedSectorRow === null || selectedSectorCol === null) {
    el.textContent = '–ù–∞–∑–Ω–∞—á–µ–Ω–æ: –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ';
  } else {
    el.textContent = '–ù–∞–∑–Ω–∞—á–µ–Ω–æ: —Å–µ–∫—Ç–æ—Ä (' + selectedSectorRow + ', ' + selectedSectorCol + ')';
  }
}

function renderGrid() {
  var vals = getGridValues();
  var inner = document.getElementById('grid-inner');
  var labelCols = document.getElementById('grid-label-cols');
  var labelRows = document.getElementById('grid-label-rows');
  if (!inner) return;
  // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∞ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –ø–æ—Å–ª–µ–¥–Ω–∏–º –∏–∑–≤–µ—Å—Ç–Ω—ã–º —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ–º —Å—Ç–æ—Ä–æ–Ω
  applyGridAspect(lastAspect);
  inner.style.gridTemplateColumns = 'repeat(' + vals.cols + ', 1fr)';
  inner.style.gridTemplateRows = 'repeat(' + vals.rows + ', 1fr)';
  labelCols.textContent = '–°—Ç–æ–ª–±—Ü–æ–≤: ' + vals.cols;
  labelRows.textContent = '–°—Ç—Ä–æ–∫: ' + vals.rows;
  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä —Å–µ–∫—Ç–æ—Ä–∞, –µ—Å–ª–∏ –æ–Ω –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã –Ω–æ–≤–æ–π —Å–µ—Ç–∫–∏
  if (selectedSectorRow !== null && (selectedSectorRow >= vals.rows || selectedSectorCol >= vals.cols)) {
    selectedSectorRow = null;
    selectedSectorCol = null;
    updateAssignedSectorMessage();
  }
  inner.innerHTML = '';
  for (var r = 0; r < vals.rows; r++) {
    for (var c = 0; c < vals.cols; c++) {
      var cell = document.createElement('div');
      cell.className = 'grid-cell';
      cell.setAttribute('data-row', r);
      cell.setAttribute('data-col', c);
      if (selectedSectorRow === r && selectedSectorCol === c) cell.classList.add('selected');
      cell.addEventListener('click', function() {
        selectedSectorRow = parseInt(this.getAttribute('data-row'), 10);
        selectedSectorCol = parseInt(this.getAttribute('data-col'), 10);
        inner.querySelectorAll('.grid-cell').forEach(function(el) { el.classList.remove('selected'); });
        this.classList.add('selected');
        updateAssignedSectorMessage();
      });
      inner.appendChild(cell);
    }
  }
}

// –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∞ —Å–µ—Ç–∫–∏ –ø–æ–¥ —Ñ–æ—Ä–º–∞—Ç –ª–∏—Å—Ç–∞ (–∞–ª—å–±–æ–º–Ω—ã–π/–∫–Ω–∏–∂–Ω—ã–π/–∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–π)
function applyGridAspect(aspect) {
  var inner = document.getElementById('grid-inner');
  if (!inner) return;
  lastAspect = aspect || 'landscape';
  var w, h;
  if (lastAspect === 'portrait') {
    w = 100;
    h = 140;
  } else if (lastAspect === 'square') {
    w = 120;
    h = 120;
  } else { // landscape –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    w = 140;
    h = 100;
  }
  inner.style.width = w + 'px';
  inner.style.height = h + 'px';
}

// –ó–∞–ø—Ä–æ—Å —Ñ–æ—Ä–º–∞—Ç–∞ —Ä–∞–±–æ—á–µ–π –æ–±–ª–∞—Å—Ç–∏ –º–∞–∫–µ—Ç–∞ –∏–∑ ACAPI –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é
function updateGridAspectFromLayoutSelection() {
  var A = window.ACAPI;
  if (!A || typeof A.GetLayoutWorkingArea !== 'function') {
    // –°—Ç–∞—Ä—ã–µ –≤–µ—Ä—Å–∏–∏ –∞–¥–¥–æ–Ω–∞: –ø—Ä–æ—Å—Ç–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫
    return;
  }

  var layoutModeEl = document.querySelector('input[name="layout-mode"]:checked');
  var mode = layoutModeEl ? layoutModeEl.value : 'existing';

  var params = {};
  if (mode === 'new') {
    var masterSel = document.getElementById('master-select');
    var masterIndex = masterSel ? parseInt(masterSel.value, 10) : -1;
    params = { mode: 'master', masterIndex: isNaN(masterIndex) ? -1 : masterIndex };
  } else {
    var layoutIndex = getSelectedLayoutIndex();
    params = { mode: 'existing', layoutIndex: layoutIndex };
  }

  A.GetLayoutWorkingArea(params).then(function(info) {
    if (!info || !info.ok) {
      // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ, –Ω–µ –ª–æ–º–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–µ—Ç–∫—É
      return;
    }
    var w = info.widthMm || 0;
    var h = info.heightMm || 0;
    if (w <= 0 || h <= 0) return;

    var aspect = 'landscape';
    var eps = 1.0;
    if (Math.abs(w - h) <= eps) {
      aspect = 'square';
    } else if (h > w) {
      aspect = 'portrait';
    }
    applyGridAspect(aspect);
    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–µ—Ç–∫—É, —á—Ç–æ–±—ã —É—á–µ—Å—Ç—å –Ω–æ–≤—ã–µ —Ä–∞–∑–º–µ—Ä—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    renderGrid();
  }).catch(function() {
    // –¢–∏—Ö–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É, —á—Ç–æ–±—ã –ø–∞–ª–∏—Ç—Ä–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–ª–∞ —Ä–∞–±–æ—Ç–∞—Ç—å
  });
}

function loadPlaceableViews() {
  var A = window.ACAPI;
  var container = document.getElementById('view-list-container');
  if (!A || typeof A.GetPlaceableViews !== 'function') {
    container.innerHTML = 'API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
    return Promise.reject();
  }
  return A.GetPlaceableViews().then(function(list) {
    if (!list || !Array.isArray(list)) {
      setInfo('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∏–¥–æ–≤: –Ω–µ–≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç API.');
      return Promise.reject();
    }
    placeableViews = list;
    renderViewList(document.getElementById('view-search').value);
  }).catch(function() {
    setInfo('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–æ–≤. –°–ø–∏—Å–æ–∫ –Ω–µ –∏–∑–º–µ–Ω—ë–Ω.');
    if (placeableViews.length > 0) {
      renderViewList(document.getElementById('view-search').value);
    }
    return Promise.reject();
  });
}

function renderViewList(filterStr) {
  var container = document.getElementById('view-list-container');
  var q = (filterStr || '').trim().toLowerCase();
  
  // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∂–∏–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
  var sortModeEl = document.querySelector('input[name="view-sort"]:checked');
  var sortMode = sortModeEl ? sortModeEl.value : 'all';
  
  // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
  var filteredViews = [];
  for (var i = 0; i < placeableViews.length; i++) {
    var v = placeableViews[i];
    var name = (v.name || '').toString();
    var typeName = (v.typeName || '').toString();
    var folderPath = (v.folderPath || '').toString();
    if (q && name.toLowerCase().indexOf(q) === -1 && typeName.toLowerCase().indexOf(q) === -1 && folderPath.toLowerCase().indexOf(q) === -1) continue;
    filteredViews.push(v);
  }
  
  var html = '<table><thead><tr><th>–í–∏–¥</th><th>–¢–∏–ø</th></tr></thead><tbody>';
  
  if (sortMode === 'byFolder') {
    // –ò–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∏–π –≤–∏–¥ —Å –ø–∞–ø–∫–∞–º–∏
    html = renderHierarchicalView(filteredViews, q);
  } else {
    // –ü–ª–æ—Å–∫–∏–π —Å–ø–∏—Å–æ–∫ (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)
    if (sortMode === 'byType') {
      filteredViews.sort(function(a, b) {
        var typeA = (a.typeName || '').toString();
        var typeB = (b.typeName || '').toString();
        if (typeA !== typeB) return typeA.localeCompare(typeB);
        return (a.name || '').toString().localeCompare((b.name || '').toString());
      });
    }
    
    html = '<table><thead><tr><th>–í–∏–¥</th><th>–¢–∏–ø</th></tr></thead><tbody>';
    var lastCategory = '';
    for (var i = 0; i < filteredViews.length; i++) {
      var v = filteredViews[i];
      var name = (v.name || '').toString();
      var typeName = (v.typeName || '').toString();
      var guid = (v.guid || '').toString();
      
      if (sortMode === 'byType') {
        if (typeName !== lastCategory) {
          html += '<tr class="category-header"><td colspan="2" style="background:#e8e6e3;font-weight:600;padding:4px 6px;">' + escapeHtml(typeName) + '</td></tr>';
          lastCategory = typeName;
        }
      }
      
      var sel = (selectedViewGuid === guid) ? ' selected' : '';
      html += '<tr data-guid="' + escapeHtml(guid) + '" class="view-row' + sel + '"><td>' + escapeHtml(name) + '</td><td>' + escapeHtml(typeName) + '</td></tr>';
    }
    html += '</tbody></table>';
  }
  
  container.innerHTML = html;
  
  // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤–∏–¥–æ–≤
  container.querySelectorAll('tr.view-row').forEach(function(tr) {
    tr.addEventListener('click', function() {
      selectedViewGuid = tr.getAttribute('data-guid');
      container.querySelectorAll('tr').forEach(function(r) { r.classList.remove('selected'); });
      tr.classList.add('selected');
    });
  });
  
  // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–∞–ø–æ–∫
  container.querySelectorAll('tr.folder-row').forEach(function(tr) {
    tr.addEventListener('click', function() {
      var folderPath = tr.getAttribute('data-folder');
      if (expandedFolders.has(folderPath)) {
        expandedFolders.delete(folderPath);
      } else {
        expandedFolders.add(folderPath);
      }
      renderViewList(filterStr);
    });
  });
}

function renderHierarchicalView(filteredViews, filter) {
  var isFiltering = filter && filter.length > 0;
  var foldersTree = {};
  var rootViews = [];
  
  // –°—Ç—Ä–æ–∏–º –¥–µ—Ä–µ–≤–æ –ø–∞–ø–æ–∫
  filteredViews.forEach(function(v) {
    var folderPath = (v.folderPath || '').toString();
    if (!folderPath) {
      rootViews.push(v);
      return;
    }
    
    var pathParts = folderPath.split('/').filter(Boolean);
    var node = foldersTree;
    
    for (var i = 0; i < pathParts.length; i++) {
      var part = pathParts[i];
      if (!node[part]) {
        node[part] = { _views: [], _children: {} };
      }
      if (i === pathParts.length - 1) {
        node[part]._views.push(v);
      } else {
        node = node[part]._children;
      }
    }
  });
  
  var html = '<table><thead><tr><th>–í–∏–¥</th><th>–¢–∏–ø</th></tr></thead><tbody>';
  var indentUnit = '\u00A0\u00A0';
  
  function addFoldersToTable(tree, parentPath, depth) {
    var folderNames = Object.keys(tree).sort(function(a, b) { return a.localeCompare(b); });
    
    folderNames.forEach(function(folderName) {
      var folderNode = tree[folderName];
      var currentPath = parentPath ? parentPath + '/' + folderName : folderName;
      var hasSubfolders = folderNode._children && Object.keys(folderNode._children).length > 0;
      var hasViews = folderNode._views && folderNode._views.length > 0;
      var hasChildren = hasSubfolders || hasViews;
      var isExpanded = isFiltering || expandedFolders.has(currentPath);
      
      // –°—Ç—Ä–æ–∫–∞ –ø–∞–ø–∫–∏
      var indicator = hasChildren ? (isExpanded ? '‚ñæ ' : '‚ñ∏ ') : '  ';
      html += '<tr class="folder-row" data-folder="' + escapeHtml(currentPath) + '" style="cursor:pointer;background:#f5f3f0;">';
      html += '<td>' + indentUnit.repeat(depth) + indicator + 'üìÅ ' + escapeHtml(folderName) + '</td>';
      html += '<td style="color:#888;">–ø–∞–ø–∫–∞</td></tr>';
      
      // –ï—Å–ª–∏ —Ä–∞—Å–∫—Ä—ã—Ç–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
      if (isExpanded) {
        // –ü–æ–¥–ø–∞–ø–∫–∏
        if (hasSubfolders) {
          addFoldersToTable(folderNode._children, currentPath, depth + 1);
        }
        
        // –í–∏–¥—ã –≤ —ç—Ç–æ–π –ø–∞–ø–∫–µ
        if (hasViews) {
          folderNode._views.sort(function(a, b) {
            return (a.name || '').toString().localeCompare((b.name || '').toString());
          }).forEach(function(v) {
            var name = (v.name || '').toString();
            var typeName = (v.typeName || '').toString();
            var guid = (v.guid || '').toString();
            var sel = (selectedViewGuid === guid) ? ' selected' : '';
            html += '<tr data-guid="' + escapeHtml(guid) + '" class="view-row' + sel + '">';
            html += '<td>' + indentUnit.repeat(depth + 1) + 'üìÑ ' + escapeHtml(name) + '</td>';
            html += '<td>' + escapeHtml(typeName) + '</td></tr>';
          });
        }
      }
    });
  }
  
  // –ö–æ—Ä–Ω–µ–≤—ã–µ –ø–∞–ø–∫–∏
  addFoldersToTable(foldersTree, '', 0);
  
  // –í–∏–¥—ã –±–µ–∑ –ø–∞–ø–∫–∏
  if (rootViews.length > 0) {
    rootViews.sort(function(a, b) {
      return (a.name || '').toString().localeCompare((b.name || '').toString());
    }).forEach(function(v) {
      var name = (v.name || '').toString();
      var typeName = (v.typeName || '').toString();
      var guid = (v.guid || '').toString();
      var sel = (selectedViewGuid === guid) ? ' selected' : '';
      html += '<tr data-guid="' + escapeHtml(guid) + '" class="view-row' + sel + '">';
      html += '<td>üìÑ ' + escapeHtml(name) + '</td>';
      html += '<td>' + escapeHtml(typeName) + '</td></tr>';
    });
  }
  
  html += '</tbody></table>';
  return html;
}

function renderQueue() {
  var container = document.getElementById('queue-container');
  if (queue.length === 0) {
    container.innerHTML = '–ü—É—Å—Ç–æ. –í—ã–±–µ—Ä–∏—Ç–µ —Å–µ–∫—Ç–æ—Ä –≤ —Å–µ—Ç–∫–µ, –≤–∏–¥ –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–î–æ–±–∞–≤–∏—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å¬ª.';
    return;
  }
  var html = '';
  queue.forEach(function(item, i) {
    html += '<div class="queue-item">' + (i + 1) + '. ' + escapeHtml(item.viewName) + ' ‚Üí —Å–µ–∫—Ç–æ—Ä (' + item.startRow + ', ' + item.startCol + ')</div>';
  });
  container.innerHTML = html;
}

function addToQueue() {
  var A = window.ACAPI;
  if (selectedSectorRow === null || selectedSectorCol === null) {
    setInfo('–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ–∫—Ç–æ—Ä –≤ —Å–µ—Ç–∫–µ (–Ω–∞–∂–º–∏—Ç–µ –Ω–∞ —è—á–µ–π–∫—É).');
    return;
  }
  if (!selectedViewGuid) {
    setInfo('–í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥ –∏–∑ —Å–ø–∏—Å–∫–∞.');
    return;
  }
  var viewName = '';
  for (var i = 0; i < placeableViews.length; i++) {
    if ((placeableViews[i].guid || '').toString() === selectedViewGuid) {
      viewName = (placeableViews[i].name || '').toString();
      break;
    }
  }
  var vals = getGridValues();
  queue.push({
    viewGuid: selectedViewGuid,
    viewName: viewName,
    gridRows: vals.rows,
    gridCols: vals.cols,
    gapMm: parseFloat(document.getElementById('grid-gap').value) || 0,
    startRow: selectedSectorRow,
    startCol: selectedSectorCol,
    spanRows: 1,
    spanCols: 1
  });
  renderQueue();
  setInfo('–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –æ—á–µ—Ä–µ–¥—å. –ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π —Å–µ–∫—Ç–æ—Ä –∏ –≤–∏–¥ –∏ —Å–Ω–æ–≤–∞ ¬´–î–æ–±–∞–≤–∏—Ç—å¬ª.');
}

function getSelectedLayoutIndex() {
  var container = document.getElementById('layout-table-container');
  var sel = container && container.querySelector('tr.selected');
  if (sel) return parseInt(sel.getAttribute('data-index'), 10);
  return -1;
}

function onOkClick() {
  var A = window.ACAPI;
  if (!A || typeof A.PlaceOnLayout !== 'function') {
    setInfo('API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.');
    return;
  }
  if (queue.length === 0) {
    setInfo('–û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞. –î–æ–±–∞–≤—å—Ç–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è.');
    return;
  }
  var layoutMode = document.querySelector('input[name="layout-mode"]:checked');
  var layoutIndex = -1;
  var masterLayoutIndex = -1;
  var layoutName = '';
  if (layoutMode && layoutMode.value === 'new') {
    masterLayoutIndex = parseInt(document.getElementById('master-select').value, 10);
    layoutName = (document.getElementById('layout-name').value || '–ù–æ–≤—ã–π –º–∞–∫–µ—Ç').trim();
    if (isNaN(masterLayoutIndex) || masterLayoutIndex < 0) {
      setInfo('–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω –º–∞–∫–µ—Ç–∞.');
      return;
    }
    if (queue.length > 1) {
      setInfo('–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –º–∞–∫–µ—Ç–∞ —Ä–∞–∑–º–µ—â–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–π –≤–∏–¥. –û—Å—Ç–∞–ª—å–Ω—ã–µ –¥–æ–±–∞–≤—å—Ç–µ –ø–æ—Å–ª–µ, –≤—ã–±—Ä–∞–≤ —Å–æ–∑–¥–∞–Ω–Ω—ã–π –º–∞–∫–µ—Ç.');
    }
  } else {
    layoutIndex = getSelectedLayoutIndex();
    if (layoutIndex < 0) {
      setInfo('–í—ã–±–µ—Ä–∏—Ç–µ –º–∞–∫–µ—Ç –≤ —Å–ø–∏—Å–∫–µ.');
      return;
    }
  }
  document.getElementById('btn-ok').disabled = true;
  setInfo('–†–∞–∑–º–µ—â–µ–Ω–∏–µ‚Ä¶');
  var idx = 0;
  var itemsToPlace = (layoutMode.value === 'new' && queue.length > 1) ? queue.slice(0, 1) : queue;
  function placeNext() {
    if (idx >= itemsToPlace.length) {
      document.getElementById('btn-ok').disabled = false;
      setInfo('–†–∞–∑–º–µ—â–µ–Ω–æ: ' + itemsToPlace.length + ' –≤–∏–¥(–æ–≤).');
      queue = [];
      renderQueue();
      return;
    }
    var item = itemsToPlace[idx];
    // –í Archicad —Ä—è–¥—ã —Å–µ—Ç–∫–∏ —Å—á–∏—Ç–∞—é—Ç—Å—è –æ—Ç –Ω–∏–∂–Ω–µ–≥–æ –∫—Ä–∞—è –ª–∏—Å—Ç–∞ –≤–≤–µ—Ä—Ö,
    // –∞ –≤ HTML-—Ç–∞–±–ª–∏—Ü–µ/preview –∏–Ω–¥–µ–∫—Å—ã —Ä–∞—Å—Ç—É—Ç —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑. –ò–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –∏–Ω–¥–µ–∫—Å —Ä—è–¥–∞.
    var regionStartRow = (item.gridRows > 0) ? (item.gridRows - 1 - item.startRow) : item.startRow;
    var params = {
      masterLayoutIndex: layoutMode.value === 'new' ? masterLayoutIndex : -1,
      layoutIndex: layoutMode.value === 'existing' ? layoutIndex : 0,
      layoutName: layoutName,
      drawingName: item.viewName,
      useGridRegion: true,
      gridRows: item.gridRows,
      gridCols: item.gridCols,
      gridGapMm: item.gapMm,
      regionStartRow: regionStartRow,
      regionStartCol: item.startCol,
      regionSpanRows: item.spanRows,
      regionSpanCols: item.spanCols,
      placeViewGuid: item.viewGuid,
      cloneViewForPlacement: true
    };
    A.PlaceOnLayout(params).then(function(success) {
      if (!success) {
        setInfo('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏–∏ ¬´' + item.viewName + '¬ª.');
        document.getElementById('btn-ok').disabled = false;
        return;
      }
      idx++;
      placeNext();
    }).catch(function() {
      setInfo('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏–∏.');
      document.getElementById('btn-ok').disabled = false;
    });
  }
  placeNext();
}

function refreshLayoutsAndViews() {
  setInfo('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ‚Ä¶');
  updateLayoutTable();
  loadPlaceableViews().then(function() {
    setInfo('–°–ø–∏—Å–∫–∏ –º–∞–∫–µ—Ç–æ–≤ –∏ –≤–∏–¥–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω—ã.');
    setTimeout(function() { setInfo(''); }, 2000);
  }).catch(function() {
    setInfo('–°–ø–∏—Å–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã.');
  });
}

function init() {
  updateLayoutTable();
  loadPlaceableViews();
  renderGrid();
  updateAssignedSectorMessage();
  var A = window.ACAPI;
  if (A && typeof A.GetMasterLayouts === 'function') {
    A.GetMasterLayouts().then(function(masters) {
      var sel = document.getElementById('master-select');
      sel.innerHTML = '';
      if (!masters || masters.length === 0) {
        sel.innerHTML = '<option value="-1">–ù–µ—Ç —à–∞–±–ª–æ–Ω–æ–≤</option>';
        return;
      }
      for (var i = 0; i < masters.length; i++) {
        var opt = document.createElement('option');
        opt.value = masters[i].index;
        opt.textContent = masters[i].name || ('–®–∞–±–ª–æ–Ω ' + (i + 1));
        sel.appendChild(opt);
      }
    });
  }
  document.querySelectorAll('input[name="layout-mode"]').forEach(function(r) {
    r.addEventListener('change', function() {
      var existingBlock = document.getElementById('layout-existing-block');
      var newBlock = document.getElementById('layout-new-block');
      if (this.value === 'existing') {
        existingBlock.style.display = '';
        newBlock.style.display = 'none';
        updateLayoutTable();
      } else {
        existingBlock.style.display = 'none';
        newBlock.style.display = '';
      }
      // –ü—Ä–∏ —Å–º–µ–Ω–µ —Ä–µ–∂–∏–º–∞ (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π / –Ω–æ–≤—ã–π –∏–∑ —à–∞–±–ª–æ–Ω–∞) –æ–±–Ω–æ–≤–ª—è–µ–º –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—é —Å–µ—Ç–∫–∏
      updateGridAspectFromLayoutSelection();
    });
  });
  document.getElementById('grid-rows').addEventListener('change', function() {
    selectedSectorRow = null;
    selectedSectorCol = null;
    renderGrid();
    updateAssignedSectorMessage();
  });
  document.getElementById('grid-cols').addEventListener('change', function() {
    selectedSectorRow = null;
    selectedSectorCol = null;
    renderGrid();
    updateAssignedSectorMessage();
  });
  document.getElementById('layout-search').addEventListener('input', function() {
    if (layoutGroupsData) renderLayoutTable(this.value);
  });
  var masterSelEl = document.getElementById('master-select');
  if (masterSelEl) {
    masterSelEl.addEventListener('change', function() {
      // –ü—Ä–∏ —Å–º–µ–Ω–µ —à–∞–±–ª–æ–Ω–∞ –º–∞–∫–µ—Ç–∞ –æ–±–Ω–æ–≤–ª—è–µ–º —Ñ–æ—Ä–º–∞—Ç –ø—Ä–µ–≤—å—é
      updateGridAspectFromLayoutSelection();
    });
  }
  document.getElementById('view-search').addEventListener('input', function() {
    renderViewList(this.value);
  });
  document.getElementById('btn-refresh').addEventListener('click', function() {
    refreshLayoutsAndViews();
  });
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ä–∞–¥–∏–æ-–∫–Ω–æ–ø–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –≤–∏–¥–æ–≤
  document.querySelectorAll('input[name="view-sort"]').forEach(function(radio) {
    radio.addEventListener('change', function() {
      renderViewList(document.getElementById('view-search').value);
    });
  });
  document.getElementById('btn-add').addEventListener('click', addToQueue);
  document.getElementById('btn-ok').addEventListener('click', onOkClick);
}

function whenReady(cb) {
  if (window.ACAPI && typeof window.ACAPI.GetPlaceableViews === 'function') {
    cb();
    return;
  }
  var n = 0;
  var iv = setInterval(function() {
    if (window.ACAPI && typeof window.ACAPI.GetPlaceableViews === 'function') {
      clearInterval(iv);
      cb();
    } else if (++n > 100) clearInterval(iv);
  }, 50);
}

whenReady(init);
</script>
</body>
</html>
