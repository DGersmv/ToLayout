<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Расположить в макете</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #efefef;
      margin: 0;
      padding: 12px;
      color: #2f2f2f;
      font-size: 12px;
    }
    .palette {
      width: 360px;
    }
    h1 {
      font-size: 13px;
      font-weight: 600;
      margin: 0 0 10px;
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }
    .section {
      margin-bottom: 12px;
    }
    .section-title {
      font-weight: 600;
      margin-bottom: 6px;
      font-size: 11px;
      color: #54524f;
    }
    .selection-list {
      max-height: 140px;
      overflow-y: auto;
      border: 1px solid #c8c4c0;
      background: #fff;
      padding: 4px;
    }
    .selection-list table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }
    .selection-list th {
      text-align: left;
      background: #dcd9d4;
      padding: 4px 6px;
      border: 1px solid #b6b2ae;
    }
    .selection-list td {
      padding: 4px 6px;
      border: 1px solid #c8c4c0;
    }
    .selection-list tbody tr:hover td {
      background: #f3f1ee;
    }
    .empty-msg {
      color: #888;
      padding: 12px;
      text-align: center;
    }
    select.layout-select, input.text-input {
      width: 100%;
      padding: 6px 8px;
      font-size: 12px;
      border: 1px solid #a8a5a2;
      background: #fff;
    }
    input.text-input {
      margin-top: 4px;
    }
    .input-row {
      margin-bottom: 8px;
    }
    .button-ok {
      width: 100%;
      padding: 8px 12px;
      margin-top: 10px;
      font-size: 12px;
      font-weight: 600;
      border: 1px solid #4f604f;
      background: linear-gradient(to bottom, #7a997a 0%, #5a7a5a 100%);
      color: #fff;
      cursor: pointer;
      border-radius: 2px;
    }
    .button-ok:hover {
      background: linear-gradient(to bottom, #8aaa8a 0%, #6a8a6a 100%);
    }
    .button-ok:disabled {
      background: #c0c0c0;
      border-color: #a0a0a0;
      cursor: default;
    }
    .info-msg {
      margin-top: 8px;
      padding: 6px;
      font-size: 11px;
      min-height: 20px;
    }
    .radio-row {
      margin: 6px 0;
    }
    .radio-row input {
      margin-right: 6px;
    }
    .anchor-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 6px;
      max-width: 200px;
    }
    .anchor-cell {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 0;
      cursor: pointer;
      font-size: 11px;
    }
    .anchor-cell input { margin: 0; }
    .anchor-spacer { visibility: hidden; }
    .mode-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      margin: 3px 0;
    }
    .layout-table {
      max-height: 160px;
      overflow-y: auto;
      border: 1px solid #c8c4c0;
      background: #fff;
      padding: 4px;
    }
    .layout-table table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }
    .layout-table th, .layout-table td {
      padding: 4px 6px;
      border: 1px solid #c8c4c0;
    }
    .layout-group-row td {
      background: #e6e2dc;
      font-weight: 600;
    }
    .layout-row:hover td {
      background: #f3f1ee;
    }
  </style>
</head>
<body>
<div class="palette">
  <h1>Расположить в макете</h1>
  <p style="font-size:11px;color:#666;margin:0 0 10px;">Окройте план, разрез или фасад — он будет размещён как связанный вид.</p>

  <div class="section">
    <div class="section-title">Выделенные элементы</div>
    <div class="selection-list" id="selection-list">
      <div class="empty-msg">Загрузка…</div>
    </div>
  </div>

  <div class="section">
    <div class="section-title">Режим размещения</div>
    <div class="mode-row">
      <label><input type="radio" name="place-mode" value="new" checked /> Новый макет по шаблону</label>
    </div>
    <div class="mode-row">
      <label><input type="radio" name="place-mode" value="existing" /> Существующий макет</label>
    </div>
  </div>

  <div class="section" id="mode-new-block">
    <div class="section-title">Шаблон макета (Основные)</div>
    <select class="layout-select" id="master-select">
      <option value="-1">Загрузка…</option>
    </select>
  </div>

  <div class="section" id="mode-new-layout-name">
    <div class="section-title">Имя макета</div>
    <input type="text" class="text-input" id="layout-name" placeholder="Новый макет" />
  </div>

  <div class="section" id="mode-existing-block" style="display:none;">
    <div class="section-title">Существующий макет</div>
    <input type="text" class="text-input" id="layout-search" placeholder="Поиск по имени макета…" style="margin-bottom:6px;" />
    <div class="layout-table" id="layout-table-container">
      <div class="empty-msg">Загрузка…</div>
    </div>
  </div>

  <div class="section">
    <div class="section-title">Имя вида</div>
    <input type="text" class="text-input" id="drawing-name" placeholder="Новый вид" />
  </div>

  <div class="section">
    <div class="section-title">Расположение на макете</div>
    <div class="anchor-grid">
      <label class="anchor-cell"><input type="radio" name="anchor" value="LT" /><span>Сверху слева</span></label>
      <label class="anchor-cell anchor-center"><input type="radio" name="anchor" value="MM" /><span>Центр</span></label>
      <label class="anchor-cell"><input type="radio" name="anchor" value="RT" /><span>Сверху справа</span></label>
      <label class="anchor-cell"><input type="radio" name="anchor" value="LB" checked /><span>Снизу слева</span></label>
      <label class="anchor-cell anchor-spacer"></label>
      <label class="anchor-cell"><input type="radio" name="anchor" value="RB" /><span>Снизу справа</span></label>
    </div>
  </div>

  <div class="section">
    <label class="anchor-cell" style="display:flex;align-items:center;gap:8px;margin:4px 0;">
      <input type="checkbox" id="fit-scale" />
      <span>Подогнать масштаб</span>
    </label>
    <p style="font-size:10px;color:#888;margin:4px 0 0 0;">Масштаб вида подгоняется под размер макета</p>
  </div>

  <div class="section">
    <label class="anchor-cell" style="display:flex;align-items:center;gap:8px;margin:4px 0;">
      <input type="checkbox" id="use-marquee-boundary" />
      <span>Выбрать по рамке</span>
    </label>
    <p style="font-size:10px;color:#888;margin:4px 0 0 0;">На плане/разрезе: выделите область рамкой. В других видах и 3D при отсутствии рамки используется zoom или выделение.</p>
  </div>

  <button type="button" class="button-ok" id="btn-ok">OK</button>

  <div class="info-msg" id="info-msg"></div>
</div>

<script type="text/javascript">
"use strict";

function setInfo(msg) {
  var el = document.getElementById('info-msg');
  if (el) el.textContent = msg || '';
}

function updateSelectionList() {
  var A = window.ACAPI;
  var container = document.getElementById('selection-list');
  if (!A || typeof A.GetSelectedElements !== 'function') {
    container.innerHTML = '<div class="empty-msg">ACAPI недоступен</div>';
    return;
  }

  A.GetSelectedElements().then(function(elemInfos) {
    if (!elemInfos || elemInfos.length === 0) {
      container.innerHTML = '<div class="empty-msg">Нет выбранных элементов</div>';
      return;
    }

    var groupMap = {};
    for (var i = 0; i < elemInfos.length; i++) {
      var guid = elemInfos[i][0];
      var typeName = elemInfos[i][1];
      var elemID = elemInfos[i][2];
      var layerName = elemInfos[i][3] || '';
      var key = typeName + '||' + elemID + '||' + layerName;
      if (!groupMap[key]) {
        groupMap[key] = { type: typeName, id: elemID, layer: layerName, count: 0 };
      }
      groupMap[key].count++;
    }

    var html = '<table><thead><tr><th>Тип</th><th>ID</th><th>Слой</th><th>Кол-во</th></tr></thead><tbody>';
    for (var key in groupMap) {
      var g = groupMap[key];
      html += '<tr><td>' + escapeHtml(g.type) + '</td><td>' + escapeHtml(g.id) + '</td><td>' + escapeHtml(g.layer) + '</td><td>' + g.count + '</td></tr>';
    }
    html += '</tbody></table>';
    container.innerHTML = html;
  }).catch(function() {
    container.innerHTML = '<div class="empty-msg">Ошибка загрузки</div>';
  });
}

function escapeHtml(text) {
  var div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function updateMasterSelect() {
  var A = window.ACAPI;
  var sel = document.getElementById('master-select');
  if (!A || typeof A.GetMasterLayouts !== 'function') {
    sel.innerHTML = '<option value="-1">GetMasterLayouts недоступен</option>';
    return;
  }

  A.GetMasterLayouts().then(function(masters) {
    sel.innerHTML = '';
    if (!masters || masters.length === 0) {
      sel.innerHTML = '<option value="-1">Нет шаблонов макетов</option>';
      return;
    }
    for (var i = 0; i < masters.length; i++) {
      var opt = document.createElement('option');
      opt.value = masters[i].index;
      opt.textContent = masters[i].name || ('Шаблон ' + (i + 1));
      sel.appendChild(opt);
    }
  }).catch(function() {
    sel.innerHTML = '<option value="-1">Ошибка загрузки</option>';
  });
}

var layoutGroupsData = null;

function renderLayoutTable(filterStr) {
  var container = document.getElementById('layout-table-container');
  if (!container || !layoutGroupsData || layoutGroupsData.length === 0) {
    if (container && layoutGroupsData && layoutGroupsData.length === 0)
      container.innerHTML = '<div class="empty-msg">В проекте нет макетов</div>';
    return;
  }
  var q = (filterStr || '').trim().toLowerCase();
  var html = '<table><thead><tr><th style="width:32px;"></th><th>Макет</th></tr></thead><tbody>';
  for (var gi = 0; gi < layoutGroupsData.length; gi++) {
    var g = layoutGroupsData[gi];
    var groupName = g.groupName || 'Группа';
    var items = g.layouts || [];
    var groupHasVisible = false;
    for (var k = 0; k < items.length; k++) {
      var it = items[k];
      var name = it.name || ('Макет ' + (typeof it.index === 'number' ? it.index + 1 : k + 1));
      if (q === '' || name.toLowerCase().indexOf(q) !== -1 || groupName.toLowerCase().indexOf(q) !== -1) {
        groupHasVisible = true;
        break;
      }
    }
    if (!groupHasVisible && q !== '') continue;
    html += '<tr class="layout-group-row"><td colspan="2">' + escapeHtml(groupName) + '</td></tr>';
    for (var k = 0; k < items.length; k++) {
      var it = items[k];
      var idx = typeof it.index === 'number' ? it.index : k;
      var name = it.name || ('Макет ' + (idx + 1));
      var match = q === '' || name.toLowerCase().indexOf(q) !== -1 || groupName.toLowerCase().indexOf(q) !== -1;
      if (!match) continue;
      html += '<tr class="layout-row">';
      html += '<td style="text-align:center;"><input type="radio" name="existing-layout" value="' + idx + '"></td>';
      html += '<td>' + escapeHtml(name) + '</td>';
      html += '</tr>';
    }
  }
  html += '</tbody></table>';
  if (html === '<table><thead><tr><th style="width:32px;"></th><th>Макет</th></tr></thead><tbody></tbody></table>') {
    container.innerHTML = '<div class="empty-msg">Нет макетов по запросу</div>';
    return;
  }
  container.innerHTML = html;
}

function updateLayoutTable() {
  var A = window.ACAPI;
  var container = document.getElementById('layout-table-container');
  if (!container)
    return;

  if (!A || (typeof A.GetLayoutsTree !== 'function' && typeof A.GetLayouts !== 'function')) {
    container.innerHTML = '<div class="empty-msg">API макетов недоступен</div>';
    return;
  }

  var promise;
  if (typeof A.GetLayoutsTree === 'function') {
    promise = A.GetLayoutsTree();
  } else {
    promise = A.GetLayouts().then(function(list) {
      return [{
        groupName: 'Макеты',
        layouts: list
      }];
    });
  }

  promise.then(function(groups) {
    layoutGroupsData = groups;
    if (!groups || groups.length === 0) {
      container.innerHTML = '<div class="empty-msg">В проекте нет макетов</div>';
      return;
    }
    var filterInput = document.getElementById('layout-search');
    renderLayoutTable(filterInput ? filterInput.value : '');
  }).catch(function() {
    layoutGroupsData = null;
    container.innerHTML = '<div class="empty-msg">Ошибка загрузки макетов</div>';
  });
}

function getCurrentPlaceMode() {
  var modes = document.querySelectorAll('input[name="place-mode"]');
  for (var i = 0; i < modes.length; i++) {
    if (modes[i].checked)
      return modes[i].value;
  }
  return 'new';
}

function setupModeSwitch() {
  var modeNewBlock = document.getElementById('mode-new-block');
  var modeNewLayoutName = document.getElementById('mode-new-layout-name');
  var modeExistingBlock = document.getElementById('mode-existing-block');
  var modes = document.querySelectorAll('input[name="place-mode"]');

  function applyMode() {
    var mode = getCurrentPlaceMode();
    if (modeNewBlock) modeNewBlock.style.display = (mode === 'new') ? '' : 'none';
    if (modeNewLayoutName) modeNewLayoutName.style.display = (mode === 'new') ? '' : 'none';
    if (modeExistingBlock) modeExistingBlock.style.display = (mode === 'existing') ? '' : 'none';

    if (mode === 'existing') {
      updateLayoutTable();
    }
  }

  for (var i = 0; i < modes.length; i++) {
    modes[i].addEventListener('change', applyMode);
  }

  var layoutSearch = document.getElementById('layout-search');
  if (layoutSearch) {
    layoutSearch.addEventListener('input', function() {
      if (layoutGroupsData) renderLayoutTable(this.value);
    });
    layoutSearch.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        this.value = '';
        if (layoutGroupsData) renderLayoutTable('');
      }
    });
  }

  applyMode();
}

var placeInProgress = false;

function onOkClick() {
  if (placeInProgress) return;
  var A = window.ACAPI;
  var masterSel = document.getElementById('master-select');
  var layoutNameEl = document.getElementById('layout-name');
  var drawingNameEl = document.getElementById('drawing-name');

  if (!A || typeof A.PlaceOnLayout !== 'function') {
    setInfo('Функция PlaceOnLayout недоступна.');
    return;
  }
  placeInProgress = true;

  var layoutName = (layoutNameEl && layoutNameEl.value.trim()) ? layoutNameEl.value.trim() : 'Новый макет';
  var drawingName = (drawingNameEl && drawingNameEl.value.trim()) ? drawingNameEl.value.trim() : 'Новый вид';

  setInfo('Размещение…');
  document.getElementById('btn-ok').disabled = true;

  var anchorRadios = document.querySelectorAll('input[name="anchor"]');
  var anchorValue = 'LB';
  for (var i = 0; i < anchorRadios.length; i++) {
    if (anchorRadios[i].checked) {
      anchorValue = anchorRadios[i].value;
      break;
    }
  }

  var fitScaleEl = document.getElementById('fit-scale');
  var fitScaleToLayout = fitScaleEl ? fitScaleEl.checked : false;

  var useMarqueeEl = document.getElementById('use-marquee-boundary');
  var useMarqueeAsBoundary = useMarqueeEl ? useMarqueeEl.checked : false;

  var mode = getCurrentPlaceMode();
  var params;

  if (mode === 'existing') {
    // Размещение на существующем макете
    var layoutRadios = document.querySelectorAll('input[name="existing-layout"]');
    var layoutIndex = -1;
    for (var j = 0; j < layoutRadios.length; j++) {
      if (layoutRadios[j].checked) {
        layoutIndex = parseInt(layoutRadios[j].value, 10);
        break;
      }
    }
    if (layoutIndex < 0 || isNaN(layoutIndex)) {
      setInfo('Выберите существующий макет.');
      document.getElementById('btn-ok').disabled = false;
      return;
    }

    params = {
      masterLayoutIndex: -1,
      layoutIndex: layoutIndex,
      layoutName: '',
      drawingName: drawingName,
      anchorPosition: anchorValue,
      fitScaleToLayout: fitScaleToLayout,
      useMarqueeAsBoundary: useMarqueeAsBoundary
    };
  } else {
    // Новый макет по шаблону (как раньше)
    var masterIndex = parseInt(masterSel.value, 10);
    if (isNaN(masterIndex) || masterIndex < 0) {
      setInfo('Выберите шаблон макета.');
      document.getElementById('btn-ok').disabled = false;
      return;
    }

    params = {
      masterLayoutIndex: masterIndex,
      layoutIndex: 0,
      layoutName: layoutName,
      drawingName: drawingName,
      anchorPosition: anchorValue,
      fitScaleToLayout: fitScaleToLayout,
      useMarqueeAsBoundary: useMarqueeAsBoundary
    };
  }

  A.PlaceOnLayout(params).then(function(success) {
    placeInProgress = false;
    document.getElementById('btn-ok').disabled = false;
    if (success) {
      setInfo('Выделение размещено в макете.');
    } else {
      setInfo('Не удалось разместить. Проверьте выделение.');
    }
  }).catch(function() {
    placeInProgress = false;
    document.getElementById('btn-ok').disabled = false;
    setInfo('Ошибка при размещении.');
  });
}

function init() {
  updateSelectionList();
  updateMasterSelect();
  setupModeSwitch();

  document.getElementById('btn-ok').addEventListener('click', onOkClick);

  window.UpdateSelectionList = updateSelectionList;
}

function whenReady(cb) {
  if (window.ACAPI && typeof window.ACAPI.GetSelectedElements === 'function') {
    cb();
    return;
  }
  var n = 0;
  var iv = setInterval(function() {
    if (window.ACAPI && typeof window.ACAPI.GetSelectedElements === 'function') {
      clearInterval(iv);
      cb();
    } else if (++n > 100) {
      clearInterval(iv);
    }
  }, 50);
}

whenReady(init);
</script>
</body>
</html>
