<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Landscape Helper ‚Äî ID / –°–ª–æ–∏</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #efefef;
      margin: 0;
      color: #2f2f2f;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 12px 0;
    }
    .palette {
      width: 360px;
      background: #efefef;
      border: 1px solid #a6a3a0;
      box-shadow: inset 0 0 0 1px #f8f8f8;
      padding: 12px;
      box-sizing: border-box;
      font-size: 12px;
      line-height: 1.35;
    }
    h1 {
      font-size: 13px;
      font-weight: 600;
      margin: 0 0 10px;
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }
    .section {
      margin-bottom: 14px;
    }
    .section-title {
      font-weight: 600;
      margin-bottom: 6px;
      text-transform: uppercase;
      font-size: 11px;
      color: #54524f;
    }
    .divider {
      height: 1px;
      background: #c7c3bd;
      margin: 10px 0;
    }
    .control-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 6px;
    }
    .control-row label {
      width: 120px;
      font-size: 11px;
      text-align: right;
    }
    .control-row input[type="text"],
    .control-row input[type="number"] {
      flex: 1;
      padding: 4px;
      border: 1px solid #ada9a4;
      border-radius: 2px;
      background: #ffffff;
      box-sizing: border-box;
      font-size: 12px;
    }
    .button-flat {
      display: inline-block;
      padding: 4px 10px;
      border: 1px solid #a8a5a2;
      border-radius: 2px;
      background: #dcd9d4;
      color: #2f2f2f;
      font-size: 12px;
      cursor: pointer;
      box-shadow: inset 0 1px 0 #f5f4f2;
      min-width: 70px;
      text-align: center;
    }
    .button-flat:hover { background: #e7e4de; }
    .button-flat:active { background: #cac7c2; }
    .button-flat:disabled { background: #e2e0de; color: #8a8a8a; cursor: default; }
    .button-primary { font-weight: 600; }
    .button-full { width: 100%; }
    .info-box {
      margin-top: 6px;
      padding: 6px;
      border: 1px solid #c0beb9;
      background: #f9f8f6;
      font-size: 11px;
      white-space: normal;
      line-height: 1.4;
    }
    .two-columns {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .two-columns > div {
      flex: 1 1 160px;
    }
    select {
      width: 100%;
      padding: 4px;
      border: 1px solid #ada9a4;
      border-radius: 2px;
      background: #ffffff;
      box-sizing: border-box;
      font-family: Consolas, 'Courier New', monospace;
      font-size: 12px;
      min-height: 180px;
    }
    .muted { color: #6a6864; font-size: 11px; }
    .controls-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }
  </style>
  <script>
    function addLog(msg) {
      if (window.DEBUG_ID_LAYERS_PALETTE) {
        console.log('[IdLayers]', msg);
      }
    }

    function setInfo(id, text) {
      const box = document.getElementById(id);
      if (box) {
        box.textContent = text;
      }
    }

    function ensureACAPI(fnName) {
      const api = window.ACAPI;
      if (!api || typeof api[fnName] !== 'function') {
        addLog('ACAPI.' + fnName + ' unavailable');
        return null;
      }
      return api[fnName].bind(api);
    }

    function whenACAPIReadyDo(cb) {
      if (typeof cb !== 'function') {
        return;
      }
      if (window.ACAPI) {
        cb();
        return;
      }
      let tries = 0;
      const iv = setInterval(() => {
        if (window.ACAPI) {
          clearInterval(iv);
          cb();
        } else if (++tries > 200) {
          clearInterval(iv);
          addLog('ACAPI not available (timeout)');
        }
      }, 50);
    }

    // =============== ID batch operations ===============
    function changeAllSelectedIDs() {
      const changeFn = ensureACAPI('ChangeSelectedElementsID');
      if (!changeFn) {
        setInfo('id-change-info', '–§—É–Ω–∫—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –û–±–Ω–æ–≤–∏—Ç–µ –ø–ª–∞–≥–∏–Ω.');
        return;
      }

      const baseInput = document.getElementById('baseID');
      const baseName = (baseInput?.value || '').trim();
      if (!baseName) {
        setInfo('id-change-info', '–í–≤–µ–¥–∏—Ç–µ –±–∞–∑–æ–≤–æ–µ –∏–º—è –¥–ª—è ID.');
        baseInput?.focus();
        return;
      }

      setInfo('id-change-info', '–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ ID...');
      addLog('ChangeSelectedElementsID ‚Üí ' + baseName);

      changeFn(baseName).then(success => {
        if (success) {
          setInfo('id-change-info', 'ID –æ–±–Ω–æ–≤–ª–µ–Ω—ã. –ù–∞–ø—Ä–∏–º–µ—Ä: ' + baseName + '-01, ' + baseName + '-02...');
          if (baseInput) baseInput.value = '';
        } else {
          setInfo('id-change-info', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å ID. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ.');
        }
      }).catch(err => {
        setInfo('id-change-info', '–û—à–∏–±–∫–∞: ' + err);
      });
    }

    // =============== Layers helper ===============
    let allLayersData = [];
    let expandedLayerFolders = new Set();
    let currentLayersFilter = '';

    function removeRootFolderPrefix(path) {
      if (!path) return '';
      if (path.startsWith('–°–ª–æ–∏/')) return path.substring('–°–ª–æ–∏/'.length);
      if (path.startsWith('Layers/')) return path.substring('Layers/'.length);
      if (path === '–°–ª–æ–∏' || path === 'Layers') return '';
      return path;
    }

    function loadExistingLayersList(filterText = '') {
      const listEl = document.getElementById('existingLayersList');
      if (!listEl) return;

      const getLayers = ensureACAPI('GetLayersList');
      if (!getLayers) {
        listEl.innerHTML = '<option value="">–§—É–Ω–∫—Ü–∏—è GetLayersList –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</option>';
        return;
      }

      listEl.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>';

      getLayers()
        .then(layersData => {
          allLayersData = [];

          if (!Array.isArray(layersData) || layersData.length === 0) {
            listEl.innerHTML = '<option value="">–°–ª–æ–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</option>';
            return;
          }

          layersData.forEach(item => {
            if (Array.isArray(item) && item.length >= 2) {
              const rawFolder = item[1] || '';
              allLayersData.push({
                name: item[0] || '',
                folder: removeRootFolderPrefix(rawFolder)
              });
            }
          });

          filterLayersList(filterText);
        })
        .catch(err => {
          addLog('GetLayersList error: ' + err);
          listEl.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ–µ–≤</option>';
        });
    }

    function filterLayersList(filterText = '') {
      const listEl = document.getElementById('existingLayersList');
      if (!listEl) return;

      currentLayersFilter = filterText || '';
      listEl.innerHTML = '';

      if (!allLayersData.length) {
        listEl.innerHTML = '<option value="">–°–ª–æ–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</option>';
        return;
      }

      const filter = currentLayersFilter.trim().toLowerCase();
      const isFiltering = filter.length > 0;
      const foldersTree = {};
      const rootLayers = [];

      allLayersData.forEach(item => {
        const layerName = item.name || '';
        const folderPath = item.folder || '';
        const fullPath = (folderPath ? folderPath + '/' : '') + layerName;

        if (!layerName) {
          return;
        }

        if (
          filter &&
          !fullPath.toLowerCase().includes(filter) &&
          !folderPath.toLowerCase().includes(filter)
        ) {
          return;
        }

        if (!folderPath) {
          rootLayers.push({
            name: layerName,
            fullPath
          });
          return;
        }

        const pathParts = folderPath.split('/').filter(Boolean);
        let node = foldersTree;

        for (let i = 0; i < pathParts.length; i++) {
          const part = pathParts[i];

          if (!node[part]) {
            node[part] = { _layers: [], _children: {} };
          }

          if (i === pathParts.length - 1) {
            node[part]._layers.push({
              name: layerName,
              fullPath,
              folderPath
            });
          } else {
            node = node[part]._children;
          }
        }
      });

      const indentUnit = '\u00A0\u00A0';

      const addFoldersToSelect = (tree, parentPath = '', depth = 0) => {
        const folderNames = Object.keys(tree).sort((a, b) => a.localeCompare(b));

        folderNames.forEach(folderName => {
          const folderNode = tree[folderName];
          const currentPath = parentPath ? parentPath + '/' + folderName : folderName;
          const hasSubfolders =
            folderNode._children && Object.keys(folderNode._children).length > 0;
          const hasLayers = folderNode._layers && folderNode._layers.length > 0;
          const hasChildren = hasSubfolders || hasLayers;
          const isExpanded = isFiltering || expandedLayerFolders.has(currentPath);

          const folderOpt = document.createElement('option');
          folderOpt.value = currentPath;
          folderOpt.dataset.type = 'folder';
          folderOpt.dataset.folder = currentPath;
          folderOpt.dataset.layer = '';
          folderOpt.dataset.expanded = isExpanded ? '1' : '0';
          const indicator = hasChildren ? (isExpanded ? '‚ñæ ' : '‚ñ∏ ') : '  ';
          folderOpt.textContent =
            indentUnit.repeat(depth) + indicator + 'üìÅ ' + folderName;
          listEl.appendChild(folderOpt);

          if (hasSubfolders && isExpanded) {
            addFoldersToSelect(folderNode._children, currentPath, depth + 1);
          }

          if (hasLayers && isExpanded) {
            folderNode._layers
              .slice()
              .sort((a, b) => a.name.localeCompare(b.name))
              .forEach(layer => {
                const layerOpt = document.createElement('option');
                layerOpt.value = layer.fullPath;
                layerOpt.dataset.type = 'layer';
                layerOpt.dataset.folder = layer.folderPath;
                layerOpt.dataset.layer = layer.name;
                layerOpt.textContent =
                  indentUnit.repeat(depth + 1) + 'üìÑ ' + layer.name;
                listEl.appendChild(layerOpt);
              });
          }
        });
      };

      addFoldersToSelect(foldersTree);

      if (rootLayers.length) {
        rootLayers.sort((a, b) => a.name.localeCompare(b.name));
        rootLayers.forEach(layer => {
          const opt = document.createElement('option');
          opt.value = layer.fullPath;
          opt.textContent = 'üìÑ ' + layer.name;
          opt.dataset.type = 'layer';
          opt.dataset.folder = '';
          opt.dataset.layer = layer.name;
          listEl.appendChild(opt);
        });
      }

      if (listEl.options.length === 0) {
        listEl.innerHTML = '<option value="">–°–æ–≤–ø–∞–¥–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</option>';
      }
    }

    function selectFromList() {
      const listEl = document.getElementById('existingLayersList');
      if (!listEl || listEl.selectedIndex < 0) return;

      const option = listEl.options[listEl.selectedIndex];
      if (!option) return;

      const optionType = option.dataset.type || 'layer';

      if (optionType === 'folder') {
        document.getElementById('layerFolder').value = option.dataset.folder || option.value;
        document.getElementById('layerName').value = '';
      } else {
        document.getElementById('layerFolder').value = option.dataset.folder || '';
        document.getElementById('layerName').value = option.dataset.layer || option.value;
      }
    }

    function handleLayersListDoubleClick() {
      const listEl = document.getElementById('existingLayersList');
      if (!listEl || listEl.selectedIndex < 0) return;

      const option = listEl.options[listEl.selectedIndex];
      if (!option) return;

      const optionType = option.dataset.type || 'layer';

      if (optionType === 'folder') {
        const folderPath = option.dataset.folder || option.value || '';
        if (expandedLayerFolders.has(folderPath)) {
          expandedLayerFolders.delete(folderPath);
        } else {
          expandedLayerFolders.add(folderPath);
        }

        filterLayersList(currentLayersFilter);

        const updatedList = document.getElementById('existingLayersList');
        if (updatedList) {
          for (let i = 0; i < updatedList.options.length; i++) {
            const opt = updatedList.options[i];
            if (
              opt.dataset.type === 'folder' &&
              (opt.dataset.folder || opt.value) === folderPath
            ) {
              updatedList.selectedIndex = i;
              break;
            }
          }
        }
      } else {
        selectFromList();
      }
    }

    function createLayerAndMoveElements() {
      const layerFolder = document.getElementById('layerFolder')?.value.trim() || '';
      const layerName = document.getElementById('layerName')?.value.trim();
      const hideLayer = !!document.getElementById('hideLayer')?.checked;

      if (!layerName) {
        setInfo('info-layers', '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–ª–æ—è.');
        document.getElementById('layerName')?.focus();
        return;
      }

      const normalizedFolder = removeRootFolderPrefix(layerFolder);
      const paramsString = normalizedFolder + '|' + layerName + '|' + (hideLayer ? '1' : '0');
      const fn = ensureACAPI('CreateLayerAndMoveElements');
      if (!fn) {
        setInfo('info-layers', '–§—É–Ω–∫—Ü–∏—è CreateLayerAndMoveElements –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.');
        return;
      }

      setInfo('info-layers', '–°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–∫–∏/—Å–ª–æ—è –∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤...');
      addLog('CreateLayerAndMoveElements ‚Üí ' + paramsString);

      fn(paramsString).then(success => {
        if (success) {
          setInfo('info-layers', hideLayer
            ? '–°–ª–æ–π —Å–æ–∑–¥–∞–Ω, —ç–ª–µ–º–µ–Ω—Ç—ã –ø–µ—Ä–µ–º–µ—â–µ–Ω—ã –∏ —Å–∫—Ä—ã—Ç—ã.'
            : '–°–ª–æ–π —Å–æ–∑–¥–∞–Ω –∏ —ç–ª–µ–º–µ–Ω—Ç—ã –ø–µ—Ä–µ–º–µ—â–µ–Ω—ã.');
          document.getElementById('layerName').value = '';
          loadExistingLayersList(document.getElementById('layerFolder')?.value || '');
        } else {
          setInfo('info-layers', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å–ª–æ–π –∏–ª–∏ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã.');
        }
      }).catch(err => {
        setInfo('info-layers', '–û—à–∏–±–∫–∞: ' + err);
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('baseID')?.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
          e.preventDefault();
          changeAllSelectedIDs();
        }
      });

      document.getElementById('layerFolder')?.addEventListener('input', e => {
        if (!e.target.value.trim()) {
          expandedLayerFolders = new Set();
        }
        filterLayersList(e.target.value);
      });

      whenACAPIReadyDo(() => loadExistingLayersList());
    });

    document.addEventListener('click', function (e) {
      const el = e.target.closest('[data-help-url]');
      if (!el) return;
      e.preventDefault();
      let url = el.getAttribute('data-help-url');
      if (!url) return;
      const separator = url.includes('?') ? '&' : '?';
      url = url + separator + 'v=' + Date.now();
      const api = window.ACAPI;
      if (api && typeof api.OpenHelp === 'function') {
        Promise.resolve(api.OpenHelp(url)).catch(err => console.log('[IdLayers] OpenHelp error:', err));
      } else {
        window.open(url, '_blank', 'noopener,noreferrer');
      }
    }, { passive: false });
  </script>
</head>
<body>
  <div class="palette">
    <h1>ID / –°–ª–æ–∏</h1>

    <div class="section" id="section-id">
      <div class="section-title">–ú–∞—Å—Å–æ–≤–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ ID</div>
      <div class="control-row">
        <label for="baseID">–ë–∞–∑–æ–≤–æ–µ –∏–º—è:</label>
        <input type="text" id="baseID" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –°–æ—Å–Ω–∞ –æ–±—ã–∫–Ω–æ–≤–µ–Ω–Ω–∞—è">
      </div>
      <button class="button-flat button-full button-primary" onclick="changeAllSelectedIDs()">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å ID –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö</button>
      <div id="id-change-info" class="info-box">
        –í–≤–µ–¥–∏—Ç–µ –±–∞–∑–æ–≤–æ–µ –∏–º—è –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É. –í—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –ø–æ–ª—É—á–∞—Ç ID —Å –Ω–æ–º–µ—Ä–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä: –°–æ—Å–Ω–∞-01, –°–æ—Å–Ω–∞-02...).
      </div>
    </div>

    <div class="divider"></div>

    <div class="section" id="section-layers">
      <div class="section-title">–°–ª–æ–∏</div>
      <div class="two-columns">
        <div>
          <label for="layerFolder">–ü–∞–ø–∫–∞ —Å–ª–æ—è:</label>
          <input type="text" id="layerFolder" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –õ–∞–Ω–¥—à–∞—Ñ—Ç/–†–∞—Å—Ç–µ–Ω–∏—è">
          <p class="muted">–†–∞–∑–¥–µ–ª—è–π—Ç–µ –ø–æ–¥–ø–∞–ø–∫–∏ —Å–∏–º–≤–æ–ª–æ–º "/" (–Ω–∞–ø—Ä–∏–º–µ—Ä: –õ–∞–Ω–¥—à–∞—Ñ—Ç/–†–∞—Å—Ç–µ–Ω–∏—è/–î–µ—Ä–µ–≤—å—è).</p>

          <label for="layerName">–ù–æ–≤—ã–π —Å–ª–æ–π:</label>
          <input type="text" id="layerName" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –°–æ—Å–Ω—ã –æ–±—ã–∫–Ω–æ–≤–µ–Ω–Ω—ã–µ">

          <label style="display:flex; align-items:center; gap:6px; margin-top:10px;">
            <input type="checkbox" id="hideLayer">–°–∫—Ä—ã—Ç—å —Å–æ–∑–¥–∞–Ω–Ω—ã–π —Å–ª–æ–π
          </label>

          <button class="button-flat button-full button-primary" onclick="createLayerAndMoveElements()">–°–æ–∑–¥–∞—Ç—å –∏ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å</button>
        </div>
        <div>
          <label>–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–∞–ø–∫–∏ –∏ —Å–ª–æ–∏:</label>
          <select id="existingLayersList" size="12" onchange="selectFromList()" ondblclick="handleLayersListDoubleClick()">
            <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
          </select>
          <p class="muted">–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ –¥–≤–∞–∂–¥—ã —â—ë–ª–∫–Ω–∏—Ç–µ —ç–ª–µ–º–µ–Ω—Ç, —á—Ç–æ–±—ã –∑–∞–ø–æ–ª–Ω–∏—Ç—å –ø–æ–ª—è.</p>
        </div>
      </div>
      <div id="info-layers" class="info-box">
        –°–æ–∑–¥–∞—ë—Ç –ø–∞–ø–∫—É (–µ—Å–ª–∏ –µ—ë –Ω–µ—Ç), —Å–æ–∑–¥–∞—ë—Ç —Å–ª–æ–π –∏ –ø–µ—Ä–µ–º–µ—â–∞–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Å–ª–æ–π —Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è.
      </div>
    </div>

    <div class="divider"></div>

    <div class="section">
      <div class="controls-row">
        <span></span>
        <button class="button-flat button-inline" data-help-url="https://landscape.227.info/help/id-layers">–°–ø—Ä–∞–≤–∫–∞</button>
      </div>
    </div>
  </div>
</body>
</html>
