<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Landscape Helper</title>

  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: Arial, sans-serif;
      background: transparent;
      margin: 0;
      padding: 0;
      margin-top: -25px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: calc(100vh + 25px);
      overflow: hidden;
      position: relative;
    }
    .palette {
      width: fit-content;
      background: transparent;
      padding: 0;
      margin: 0;
    }
    
    /* ==== Archicad-style toolbar ==== */
    .ac-toolbar {
      display: flex;
      align-items: stretch;
      gap: 2px;
      padding: 4px 6px 4px 6px;
      background: linear-gradient(to bottom, #f5f5f5 0%, #e3e3e3 50%, #d0d0d0 100%);
      border: 1px solid #b0b0b0;
      box-shadow: 0 1px 0 #ffffff inset, 0 -1px 0 rgba(0,0,0,0.1);
      border-radius: 2px;
      position: relative;
    }
    
    .ac-close-btn {
      position: absolute;
      top: 3px;
      right: 3px;
      width: 18px;
      height: 18px;
      padding: 0;
      border: 1px solid rgba(0,0,0,0.25);
      background: linear-gradient(to bottom, #ffffff 0%, #f2f2f2 50%, #e2e2e2 100%);
      border-radius: 2px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      line-height: 1;
      color: #2f2f2f;
      box-shadow: 0 1px 0 #ffffff inset;
      z-index: 10;
    }
    
    .ac-close-btn:hover {
      background: linear-gradient(to bottom, #ffffff 0%, #ffebeb 50%, #ffd0d0 100%);
      border-color: #cc0000;
      color: #cc0000;
    }
    
    .ac-close-btn:active {
      filter: brightness(0.9);
      box-shadow: 0 1px 2px rgba(0,0,0,0.2) inset;
    }

    .ac-tool-btn {
      width: 28px;
      height: 28px;
      padding: 2px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 2px;
      border: 1px solid rgba(0,0,0,0.25);
      background: linear-gradient(to bottom, #ffffff 0%, #f2f2f2 50%, #e2e2e2 100%);
      box-shadow: 0 1px 0 #ffffff inset;
      cursor: pointer;
      position: relative;
    }

    .ac-tool-btn svg {
      width: 100%;
      height: 100%;
    }

    .ac-tool-btn:hover {
      filter: brightness(1.07);
    }

    .ac-tool-btn:active {
      filter: brightness(0.95);
      box-shadow: 0 1px 2px rgba(0,0,0,0.2) inset;
    }

    .ac-tool-btn.ac-active {
      border-color: #4f604f;
      background: linear-gradient(to bottom, #ffffff 0%, #dfe5df 50%, #c7d0c7 100%);
      box-shadow: 0 0 0 1px rgba(79,96,79,0.3) inset;
    }
  </style>

  <script type="text/javascript">
    "use strict";

    // ================= helpers =================
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function setInfo(id, msg) {
      const el = document.getElementById(id);
      if (el) el.textContent = msg;
    }

    // =============== ACAPI bridge waiting ===============
    function whenACAPIReadyDo(cb) {
      let fired = false;
      const probe = () => {
        const A = window.ACAPI;
        if (!A) return null;
        return {
          hasSelect : typeof A.GetSelectedElements === 'function',
          hasGround : typeof A.ApplyGroundOffset  === 'function',
          hasNewDlt : typeof A.SetZDelta         === 'function' && typeof A.ApplyZDelta === 'function',
          hasOldDlt : typeof A.ApplyZDelta       === 'function' && A.ApplyZDelta.length >= 1
        };
      };
      const ready = () => {
        const caps = probe();
        return caps && (caps.hasSelect || caps.hasGround || caps.hasNewDlt || caps.hasOldDlt);
      };
      const fire = () => {
        if (fired) return;
        fired = true;
        try {
          const caps = probe();
          cb();
        } catch (e) { console.log('[UI] callback error: ' + e); }
      };

      if (ready()) { fire(); return; }

      let tries = 0;
      const maxTries = 120;
      const iv = setInterval(() => {
        if (ready()) {
          clearInterval(iv);
          fire();
        } else if (++tries > maxTries) {
          clearInterval(iv);
        }
      }, 50);
    }

    // =============== ID renaming (bulk, without layers) ===============
    function changeAllSelectedIDs() {
      const A = window.ACAPI;
      if (!A || typeof A.ChangeSelectedElementsID !== 'function') {
        return;
      }
      
      const baseID = document.getElementById('baseID').value.trim();
      if (!baseID) {
        document.getElementById('baseID').focus();
        return;
      }
      
      A.ChangeSelectedElementsID(baseID).then(function(success) {
        if (success) {
          setInfo("id-change-info", "ID обновлены. Например: " + baseID + "-01, " + baseID + "-02, " + baseID + "-03...");
          document.getElementById('baseID').value = '';
        } else {
          setInfo("id-change-info", "Ошибка! Возможно, нет выбранных элементов или элемент не поддерживает изменение ID");
        }
      }).catch(function(err) {
        setInfo("id-change-info", "Ошибка: " + err);
      });
    }

    // Храним полный список для фильтрации
    let allLayersData = [];
    let expandedLayerFolders = new Set();
    let currentLayersFilter = '';

    function loadExistingLayersList(filter) {
      const A = window.ACAPI;
      if (!A || typeof A.GetLayersList !== 'function') {
        return;
      }
      
      currentLayersFilter = filter || '';
      
      A.GetLayersList().then(function(layers) {
        allLayersData = layers || [];
        filterLayersList(currentLayersFilter);
      }).catch(function(err) {
        console.log('[UI] GetLayersList error: ' + err);
      });
    }

    function filterLayersList(filter) {
      const listEl = document.getElementById('existingLayersList');
      if (!listEl) return;
      
      const filterLower = (filter || '').toLowerCase();
      const filtered = allLayersData.filter(layer => {
        const nameMatch = !filterLower || layer[0].toLowerCase().includes(filterLower);
        const folderMatch = !filterLower || !layer[1] || layer[1].toLowerCase().includes(filterLower);
        return nameMatch || folderMatch;
      });
      
      // Группируем по папкам
      const folderMap = {};
      const rootLayers = [];
      
      filtered.forEach(layer => {
        const folder = layer[1] || '';
        if (folder) {
          if (!folderMap[folder]) {
            folderMap[folder] = [];
          }
          folderMap[folder].push(layer);
        } else {
          rootLayers.push(layer);
        }
      });
      
      listEl.innerHTML = '';
      
      // Добавляем корневые слои
      rootLayers.forEach(layer => {
        const opt = document.createElement('option');
        opt.value = layer[0];
        opt.textContent = layer[0];
        opt.dataset.type = 'layer';
        listEl.appendChild(opt);
      });
      
      // Добавляем папки и их слои
      Object.keys(folderMap).sort().forEach(folder => {
        const isExpanded = expandedLayerFolders.has(folder);
        const opt = document.createElement('option');
        opt.value = folder;
        opt.textContent = (isExpanded ? '▼ ' : '▶ ') + folder;
        opt.dataset.type = 'folder';
        opt.dataset.folder = folder;
        listEl.appendChild(opt);
        
        if (isExpanded) {
          folderMap[folder].forEach(layer => {
            const layerOpt = document.createElement('option');
            layerOpt.value = layer[0];
            layerOpt.textContent = '  ' + layer[0];
            layerOpt.dataset.type = 'layer';
            layerOpt.dataset.folder = folder;
            listEl.appendChild(layerOpt);
          });
        }
      });
    }

    function handleLayersListDoubleClick() {
      const listEl = document.getElementById('existingLayersList');
      if (!listEl || listEl.selectedIndex < 0) return;

      const selectedOption = listEl.options[listEl.selectedIndex];
      if (!selectedOption) return;

      const optionType = selectedOption.dataset.type || 'layer';

      if (optionType === 'folder') {
        const folderPath = selectedOption.dataset.folder || selectedOption.value || '';
        if (expandedLayerFolders.has(folderPath)) {
          expandedLayerFolders.delete(folderPath);
        } else {
          expandedLayerFolders.add(folderPath);
        }

        filterLayersList(currentLayersFilter);

        const updatedList = document.getElementById('existingLayersList');
        if (updatedList) {
          for (let i = 0; i < updatedList.options.length; i++) {
            const opt = updatedList.options[i];
            if (
              opt.dataset.type === 'folder' &&
              (opt.dataset.folder || opt.value) === folderPath
            ) {
              updatedList.selectedIndex = i;
              break;
            }
          }
        }
      }
    }

    // =============== orientation/distribution/... ===============
    function SetDistributionLine()     { if (ACAPI?.SetDistributionLine)     ACAPI.SetDistributionLine();     setInfo("info-dist","Линия установлена"); }
    function SetDistributionObject()   { if (ACAPI?.SetDistributionObject)   ACAPI.SetDistributionObject();   setInfo("info-dist","Объект установлен"); }
    
    function openSelectionDetailsPalette() {
      if (ACAPI?.OpenSelectionDetailsPalette) {
        ACAPI.OpenSelectionDetailsPalette();
      }
    }
    
    function openDistributionPalette() {
      if (ACAPI?.OpenDistributionPalette) {
        ACAPI.OpenDistributionPalette();
      }
    }
    function openOrientationPalette() {
      if (ACAPI?.OpenOrientationPalette) {
        ACAPI.OpenOrientationPalette();
      }
    }
    function openGroundPalette() {
      if (ACAPI?.OpenGroundPalette) {
        ACAPI.OpenGroundPalette();
      }
    }
    function openMarkupPalette() {
      if (ACAPI?.OpenMarkupPalette) {
        ACAPI.OpenMarkupPalette();
      }
    }
    function openIdLayersPalette() {
      if (ACAPI?.OpenIdLayersPalette) {
        ACAPI.OpenIdLayersPalette();
      }
    }
    function openAnglePalette() {
      if (ACAPI?.OpenAnglePalette) {
        ACAPI.OpenAnglePalette();
      }
    }
    function openMeshPalette() {
      if (ACAPI?.OpenMeshPalette) {
        ACAPI.OpenMeshPalette();
      }
    }
    function openContourPalette() {
      if (ACAPI?.OpenContourPalette) {
        ACAPI.OpenContourPalette();
      }
    }
    function openSendXlsPalette() {
      if (ACAPI?.OpenSendXlsPalette) {
        ACAPI.OpenSendXlsPalette();
      }
    }
    function openRandomizerPalette() {
      if (ACAPI?.OpenRandomizerPalette) {
        ACAPI.OpenRandomizerPalette();
      }
    }

    function openHelp() {
      const url = "https://landscape.227.info/help";
      if (ACAPI?.OpenHelp) {
        ACAPI.OpenHelp(url);
      } else {
        window.open(url, '_blank', 'noopener,noreferrer');
      }
    }
    
    function closePalette() {
      if (ACAPI?.ClosePalette) {
        ACAPI.ClosePalette();
      } else if (window.parent && window.parent !== window) {
        // Если встроено в палитру, попробуем закрыть через родительское окно
        try {
          window.parent.postMessage({action: 'close'}, '*');
        } catch(e) {}
      }
    }

    // Инициализация при загрузке
    document.addEventListener('DOMContentLoaded', function() {
      const buttons = document.querySelectorAll('.ac-tool-btn');
      let active = null;

      buttons.forEach(btn => {
        btn.addEventListener('click', function() {
          const tool = this.dataset.tool;
          
          // Убираем активность с предыдущей кнопки
          if (active) active.classList.remove('ac-active');
          
          // Добавляем активность на текущую (опционально, можно убрать если не нужно)
          // this.classList.add('ac-active');
          // active = this;
          
          // Вызываем соответствующую функцию
          switch(tool) {
            case 'table':
              openSelectionDetailsPalette();
              break;
            case 'spline':
              openDistributionPalette();
              break;
            case 'rotate':
              openOrientationPalette();
              break;
            case 'rotSurf':
              openAnglePalette();
              break;
            case 'land':
              openGroundPalette();
              break;
            case 'dims':
              openMarkupPalette();
              break;
            case 'layers':
              openIdLayersPalette();
              break;
            case 'contour':
              openContourPalette();
              break;
            case 'mesh':
              openMeshPalette();
              break;
            case 'csv':
              openSendXlsPalette();
              break;
            case 'randomizer':
              openRandomizerPalette();
              break;
            case 'support':
              openHelp();
              break;
          }
        });
      });

      // wait for bridge
      whenACAPIReadyDo(() => {
        // ACAPI ready
      });
    });
  </script>
</head>

<body>
<div class="palette">
  <!-- === Archicad-style toolbar === -->
  <div class="ac-toolbar">
    <button class="ac-close-btn" onclick="closePalette()" title="Закрыть">×</button>
    <!-- Таблица -->
    <button class="ac-tool-btn" data-tool="table" title="Выбранные элементы">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none"
           viewBox="0 0 24 24" stroke="#346233" stroke-width="1.5">
        <path stroke-linecap="round" stroke-linejoin="round"
              d="M3 5.25h18v13.5H3V5.25zM3 9.75h18M9 5.25v13.5" />
      </svg>
    </button>

    <!-- Spline -->
    <button class="ac-tool-btn" data-tool="spline" title="Распределение">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none"
           viewBox="0 0 24 24" stroke="#346233" stroke-width="1.5">
        <path d="M3 12q3-5 6 0t6 0t6 0" />
        <circle cx="6" cy="9.5" r="1.5" stroke="#346233" />
        <circle cx="12" cy="14.5" r="1.5" stroke="#346233" />
        <circle cx="18" cy="9.5" r="1.5" stroke="#346233" />
      </svg>
    </button>

    <!-- Поворот -->
    <button class="ac-tool-btn" data-tool="rotate" title="Ориентация">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none"
           viewBox="0 0 24 24" stroke="#346233" stroke-width="1.5">
        <rect x="9" y="9" width="6" height="6" rx="1" />
        <path d="M17.05 17.05A7.15 7.15 0 1 1 6.95 6.95" />
        <path d="M8.5 6L6.95 6.95L6 8.5" />
        <path d="M15.5 3.5L17 5L15.5 6.5" />
      </svg>
    </button>

    <!-- Поворот по поверхности -->
    <button class="ac-tool-btn" data-tool="rotSurf" title="Угол">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none"
           viewBox="0 0 24 24" stroke="#346233" stroke-width="1.5">
        <path d="M4 18q8-8 16 0" opacity="0.5" />
        <path d="M4 14q8-8 16 0" opacity="0.5" />
        <path d="M8 12.5v6" opacity="0.5" />
        <path d="M12 12v6" opacity="0.5" />
        <path d="M16 12.5v6" opacity="0.5" />
        <rect x="8" y="9" width="8" height="5" rx="1" />
        <path d="M17.05 17.05A7.15 7.15 0 1 1 6.95 6.95" />
        <path d="M8.5 6L6.95 6.95L6 8.5" />
        <path d="M18.5 6.5L17 5L18.5 3.5" />
      </svg>
    </button>

    <!-- Приземлить -->
    <button class="ac-tool-btn" data-tool="land" title="Привязка">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none"
           viewBox="0 0 24 24" stroke="#346233" stroke-width="1.5">
        <path d="M8 4h8v8H8V4z" />
        <path d="M12 12v3m-2 1l2 2 2-2" />
        <path d="M3 20c3-3 6 3 9 0s6 3 9 0" />
      </svg>
    </button>

    <!-- Размеры -->
    <button class="ac-tool-btn" data-tool="dims" title="Разметка">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none"
           viewBox="0 0 24 24" stroke="#346233" stroke-width="1.5">
        <path d="M4 16h16 M4 14v4 M2.5 17.5l3-3 M20 14v4 M18.5 17.5l3-3" />
      </svg>
    </button>

    <!-- Слои -->
    <button class="ac-tool-btn" data-tool="layers" title="ID / Слои">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none"
           viewBox="0 0 24 24" stroke="#346233" stroke-width="1.5">
        <path d="M8 8h10v10H8z" opacity="0.6" />
        <path d="M4 4h10v10H4z" />
        <path d="M18 6v4m-2-2h4" />
      </svg>
    </button>

    <!-- Контур -->
    <button class="ac-tool-btn" data-tool="contour" title="Контуры">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none"
           viewBox="0 0 24 24" stroke="#346233" stroke-width="1.5">
        <path d="M3 6h18v12H3z" />
        <path stroke-dasharray="4 2" d="M3 12h18" />
      </svg>
    </button>

    <!-- Mesh -->
    <button class="ac-tool-btn" data-tool="mesh" title="Сетка">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none"
           viewBox="0 0 24 24" stroke="#346233" stroke-width="1.5">
        <path d="M3 16c3-3 6 3 9 0s6-3 9 0" opacity="0.6" />
        <path d="M3 8c3-3 6 3 9 0s6-3 9 0" opacity="0.6" />
        <path d="M6 4v16" opacity="0.6" />
        <path d="M12 4v16" opacity="0.6" />
        <path d="M18 4v16" opacity="0.6" />
        <path stroke-dasharray="4 2"
              d="M3 12c3-3 6 3 9 0s6-3 9 0" />
      </svg>
    </button>

    <!-- CSV -->
    <button class="ac-tool-btn" data-tool="csv" title="Экспорт CSV">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none">
        <g stroke="#346233" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
          <!-- Таблица / CSV -->
          <rect x="3" y="4" width="11" height="16" rx="1.5" />
          <!-- Вертикальные линии -->
          <path d="M7 4v16" />
          <path d="M11 4v16" />
          <!-- Горизонтальные линии -->
          <path d="M3 9h11" />
          <path d="M3 13h11" />
          <path d="M3 17h11" />
          <!-- Стрелка экспорта -->
          <path d="M15 12h6" />
          <path d="M18.5 8.5L21 12l-2.5 3.5" />
        </g>
      </svg>
    </button>

    <!-- Randomizer -->
    <button class="ac-tool-btn" data-tool="randomizer" title="Рандомизатор">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none">
        <g stroke="#346233" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <!-- Объект (базовый прямоугольник) -->
          <rect x="7" y="7" width="10" height="10" rx="1.5" />
          <!-- Горизонтальная стрелка (ширина) -->
          <path d="M4 12h3" />
          <path d="M3 12l1.5-1.5M3 12l1.5 1.5" />
          <path d="M17 12h3" />
          <path d="M21 12l-1.5-1.5M21 12l-1.5 1.5" />
          <!-- Вертикальная стрелка (высота/длина) -->
          <path d="M12 4v3" />
          <path d="M12 3l-1.5 1.5M12 3l1.5 1.5" />
          <path d="M12 17v3" />
          <path d="M12 21l-1.5-1.5M12 21l1.5-1.5" />
          <!-- Круговая стрелка (рандом по углу) -->
          <path d="M15.5 1.5 L17 3 L15.5 5" />
        </g>
      </svg>
    </button>

    <!-- Поддержка -->
    <button class="ac-tool-btn" data-tool="support" title="Поддержка">
      <svg xmlns="http://www.w3.org/2000/svg"
           viewBox="0 0 24 24"
           fill="none" stroke="#346233" stroke-width="1.5"
           stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="9" stroke="#346233" />
        <path d="M9.5 9a2.5 2.5 0 1 1 3.8 2.1c-.8.5-1.3 1.2-1.3 2.2"
              stroke="#346233" />
        <path d="M12 17.5 L12 17.5" stroke="#346233" stroke-width="2.2" />
      </svg>
    </button>
  </div>
</div>
</body>
</html>
